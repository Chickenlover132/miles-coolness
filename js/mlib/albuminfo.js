let albumSongs=[],albumSongIndex=0,aud=null,isPlaying=!1;function displayAlbumSongs(e){const n=indexedDB.open("songs_db",2);n.onupgradeneeded=function(e){const n=e.target.result;n.objectStoreNames.contains("songs")||n.createObjectStore("songs",{keyPath:"name"})},n.onsuccess=function(n){const t=n.target.result.transaction(["songs"],"readonly").objectStore("songs");let o=[];const a=document.getElementById("albumsDivs");t.openCursor().onsuccess=function(n){const t=n.target.result;if(t){const n=t.value;n.album===e&&o.push(n),t.continue()}else{if(0===o.length)return void(a.textContent="No songs found in album.");o.sort(((e,n)=>e.track-n.track)),o.forEach((function(e,n){e.index=n;const t=document.createElement("div");let o;t.classList.add("songDiv"),o="Unknown Title"==e.name?e.filename:e.name,"Unknown Artist"==e.artist&&(e.artist=""),"Unknown Album"==e.album&&(e.album=""),"Unknown Year"==e.year&&(e.year=""),t.innerHTML=`<img class="songImage" src="${e.image||"../assets/defaultSong.jpg"}" onclick="playAlbumSong('${e.name}'); albumSongIndex = ${n};">\n                                        <div class="songTitle">${o}</div>\n                                        <div class="songYear">${e.year||""}</div>`,a.appendChild(t)}))}}},n.onerror=function(e){console.error("IndexedDB error: ",e.target.errorCode)}}function logAlbumSongs(e){const n=indexedDB.open("songs_db",2);n.onupgradeneeded=function(e){const n=e.target.result;n.objectStoreNames.contains("songs")||n.createObjectStore("songs",{keyPath:"name"})},n.onsuccess=function(n){const t=n.target.result.transaction(["songs"],"readonly").objectStore("songs");albumSongs=[];const o=t.openCursor();o.onsuccess=function(n){const t=n.target.result;if(t){const n=t.value;n.album===e&&(albumSongs[n.track-1]=n.name,console.log(`Song added at position ${n.track-1}: ${n.name}`)),t.continue()}else{const n=albumSongs.filter((function(e){return void 0!==e}));albumSongs.length=0,albumSongs.push(...n),console.log(`Songs in album "${e}":`),albumSongs.forEach((function(e){console.log(e)}))}},o.onerror=function(e){console.error("IndexedDB error: ",e.target.errorCode)}},n.onerror=function(e){console.error("IndexedDB error: ",e.target.errorCode)}}function playAlbumSong(e){aud&&!aud.paused&&aud.pause();indexedDB.open("songs_db",2).onsuccess=function(n){const t=n.target.result;console.log(albumSongs),console.log(e);t.transaction(["songs"],"readonly").objectStore("songs").get(e).onsuccess=function(e){const n=e.target.result.data;aud=new Audio(n),isPlaying=!aud.paused,aud.play(),getID3Data(n),raiseSidebar(),aud.addEventListener("ended",playNextSong)}}}function playPreviousSong(){albumSongIndex>0?albumSongIndex--:albumSongIndex=albumSongs.length-1,playAlbumSong(albumSongs[albumSongIndex])}function playNextSong(){albumSongIndex<albumSongs.length-1?albumSongIndex++:albumSongIndex=0,playAlbumSong(albumSongs[albumSongIndex])}const urlParams=new URLSearchParams(window.location.search),albumName=urlParams.get("album");albumName&&(displayAlbumSongs(albumName),logAlbumSongs(albumName)),document.title=`Album: ${albumName}`;let pageTitle=document.getElementById("pageTitle");function raiseSidebar(){let e=document.getElementById("songTitle"),n=document.getElementById("songArtist"),t=document.getElementById("songPhoto"),o=localStorage.getItem("songTitle"),a=localStorage.getItem("songArtist"),s=localStorage.getItem("songArt");null===o&&(o="Unknown Title"),null===a&&(a="Unknown Artist"),null===s||(e.innerHTML=o,n.innerHTML=a,t.src=s),progressBar(),logCurrentTime()}function progressBar(){isPlaying||setInterval((function(){const e=aud.currentTime/aud.duration*100;document.getElementById("progressBar").style.width=`${e}%`}),1e3)}function logCurrentTime(){let e=document.getElementById("currentTime");setInterval((function(){const n=aud.currentTime,t=aud.duration,o=Math.floor(n/60),a=Math.floor(n%60),s=Math.floor(t/60),r=Math.floor(t%60),l=`${o.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}/${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`;e.innerHTML=l}),1e3)}function pausePlay(){aud&&!aud.paused?(aud.pause(),isPlaying=!1):aud&&(aud.play(),isPlaying=!0)}function getID3Data(e,n,t){try{let o=dataURItoBlob(e);jsmediatags.read(o,{onSuccess:function(o){console.log(o);let a=o.tags.title||t,s=o.tags.artist||"",r=o.tags.album||"",l=o.tags.year||"",g=o.tags.picture,u=o.tags.track||"",c=null;if(g){let e="";for(let n=0;n<g.data.length;n++)e+=String.fromCharCode(g.data[n]);let n="data:"+g.format+";base64,"+window.btoa(e);c=n}else c="../assets/defaultSong.jpg";if(n){const n=indexedDB.open("songs_db",2);n.onupgradeneeded=function(e){const n=e.target.result;n.objectStoreNames.contains("songs")||n.createObjectStore("songs",{keyPath:"name"})},n.onsuccess=function(n){n.target.result.transaction(["songs"],"readwrite").objectStore("songs").add({name:a,artist:s,album:r,year:l,data:e,image:c,filename:t,track:u}),console.log(e),localStorage.setItem("loaded","1")},n.onerror=function(e){console.error("IndexedDB error: ",e.target.errorCode)}}let i=document.getElementById("songTitle");null===a||""===a?(a=t,localStorage.setItem("songTitle",a)):(i.innerHTML=a,localStorage.setItem("songTitle",a));let d,m=document.getElementById("songArtist");null===s||""===s?(s="Unknown Artist",localStorage.setItem("songArtist",s)):(m.innerHTML=s,localStorage.setItem("songArtist",s)),null===r||""===r?(r="Unknown Album",localStorage.setItem("songAlbum",r)):(d=r,localStorage.setItem("songAlbum",r));let b=document.getElementById("songPhoto");if(c?(b.src=c,localStorage.setItem("songArt",c)):console.log("No picture found."),console.log("Title: "+a+", Artist: "+s),!n){aud.duration}},onError:function(o){let a=t||"Unknown Title",s="Unknown Artist",r="Unknown Album",l="../assets/defaultSong.jpg";document.getElementById("songTitle").innerHTML=a,localStorage.setItem("songTitle",a),document.getElementById("songArtist").innerHTML=s,localStorage.setItem("songArtist",s);if(localStorage.setItem("songAlbum",r),document.getElementById("songPhoto").src=l,localStorage.setItem("songArt",l),n){const n=indexedDB.open("songs_db",2);n.onupgradeneeded=function(e){const n=e.target.result;n.objectStoreNames.contains("songs")||n.createObjectStore("songs",{keyPath:"name"})},n.onsuccess=function(n){n.target.result.transaction(["songs"],"readwrite").objectStore("songs").add({name:a,artist:s,album:r,year:"Unknown Year",data:e,image:l,filename:t,track:"Unknown Track Number"}),console.log(e),localStorage.setItem("loaded","1")}}}})}catch(e){console.log(e)}}function dataURItoBlob(e){for(var n=atob(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],o=new ArrayBuffer(n.length),a=new Uint8Array(o),s=0;s<n.length;s++)a[s]=n.charCodeAt(s);return new Blob([o],{type:t})}pageTitle.innerHTML=`Album: ${albumName}`;